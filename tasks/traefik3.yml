---

## Title: tasks/traefik.yml
## Description: Setup Traefik v3 as a reverse proxy and load balancer in Docker Swarm mode
## Author: Joseph Harry <findarato@gmail.com>
## Copyright: Joseph Harry <findarato@gmail.com>
## Date: 2025-09-12 11:47:43
## 
## This program is free software; you can redistribute it and/or modify
## it under the terms of the GNU General Public License as published by
## the Free Software Foundation; either version 2 of the License, or
## (at your option) any later version.
## This program is distributed in the hope that it will be useful,
## but WITHOUT ANY WARRANTY; without even the implied warranty of
## MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
## GNU General Public License for more details.
## You should have received a copy of the GNU General Public License along
## with this program; if not, write to the Free Software Foundation, Inc.
## 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.


- name: 'Create network'
  community.docker.docker_network:
    name: "{{ traefik_proxy_network }}"
    driver: 'overlay'
    internal: false
    attachable: true
  tags:
    - traefik

- name: 'Create directory for container data'
  ansible.builtin.file:
    path: "{{ docker_data_dir }}/{{ dir }}"
    owner: 'ubuntu'
    group: 'ubuntu'
    mode: '0750'
    state: 'directory'
  loop:
    - 'traefik3_data'
    - 'traefik3_data/certs/'
  loop_control:
    loop_var: 'dir'
  tags:
    - traefik

- name: 'Deploy traefik3 YML config'
  ansible.builtin.copy:
    src: 'files/traefik3/traefik.yml'
    dest: "{{ docker_data_dir }}/traefik3_data/traefik.yml"
    owner: 'root'
    group: 'root'
    mode: '0644'
  tags:
    - traefik

- name: 'Deploy Traefik YML Extra config'
  ansible.builtin.copy:
    src: 'files/traefik3/config.yml'
    dest: "{{ docker_data_dir }}/traefik3_data/config.yml"
    owner: 'root'
    group: 'root'
    mode: '0644'
  tags:
    - traefik

- name: 'ðŸ”¥ Remove Traefik'
  community.docker.docker_swarm_service:
    name: 'traefik'
    state: absent
  tags:
    - traefik

- name: 'ðŸ”¥ Remove Whoami'
  community.docker.docker_swarm_service:
    name: 'whoami'
    state: absent
  tags:
    - traefik
    - whoami


- name: 'Deploy Traefik'
  community.docker.docker_swarm_service:
    name: 'traefik'
    image: 'traefik:{{ traefik3_version }}'
    # state: absent
    force_update: true
    command:
      - '/usr/local/bin/traefik'
      - --entrypoints.websecure.http.tls=true
      - --providers.file.filename=/traefik.yml'
    labels:
      traefik.http.routers.websecure.tls.certresolver: "cloudflare"
      traefik.http.routers.websecure.tls.domains[0].main: "*.mcharryville.space"
      traefik.http.routers.websecure.tls.domains[0].sans: "*.rk1.mcharryville.space"
      traefik.http.routers.websecure.service[0]: "api@internal"
      traefik.http.routers.websecure.service[1]: "ping@internal"
      traefik.http.routers.whoami.tls.certresolver: "cloudflare"
      
    env:
      # - "CF_API_EMAIL={{ vault_cf_api_email }}"   # Do not use if using token
      # - "CF_API_KEY={{ vault_cf_api_key }}"       # Do not use if using token
      - "CF_DNS_API_TOKEN={{ vault_cf_api_token }}"
    mounts:
      - source: '/var/run/docker.sock'
        target: '/var/run/docker.sock'
        type: 'bind'
        readonly: true
      - source: '{{ docker_data_dir }}/traefik3_data/traefik.yml'
        target: '/traefik.yml'
        type: 'bind'
      - source: '{{ docker_data_dir }}/traefik3_data/certs'
        target: '/certs/'
        type: 'bind'
        readonly: false
      - source: '{{ docker_data_dir }}/traefik3_data/config.yml'
        target: '/config.yml'
        type: 'bind'
        readonly: true
    networks:
      - "{{ traefik_proxy_network }}"
    dns:
      - "{{ public_dns_servers[0] }}"
      - "{{ public_dns_servers[1] }}"
    # mode: 'global'
    mode: 'replicated'
    replicas: 1
    restart_config:
      condition: "{{ restart_condition }}"
    publish:
      - published_port: 80
        target_port: 80
        mode: "host"
      - published_port: 443
        target_port: 443
        mode: "host"
      - published_port: 8080
        target_port: 8080
        mode: "host"
      - published_port: 8082
        target_port: 8082
        mode: "host"
      - published_port: 3333
        target_port: 3333
        mode: "host"
      # - published_port: 53
      #   target_port: 53
      #   protocol: "udp"
      #   mode: "host"
      - published_port: 58846
        target_port: 58846
        protocol: "tcp"
        mode: "host"
    placement:
      constraints:
        - node.role == manager
        - node.hostname == rk1-cluster02
  tags:
    - traefik

- name: 'Deploy whoami'
  community.docker.docker_swarm_service:
    name: 'whoami'
    image: "traefik/whoami"
    force_update: true
    networks:
      - 'traefik_proxy'
    labels:
      traefik.enable: "true"
      traefik.http.routers.whoami.rule: "Host(`whoami.{{ traefik_domain_rk1 }}`)"
      traefik.http.routers.whoami.entrypoints: websecure
      traefik.http.routers.whoami.tls: "true"
      traefik.http.routers.whoami.tls.certresolver: cloudflare
      traefik.http.services.whoami.loadbalancer.server.port: "80"
    mode: 'replicated'
    replicas: 8
    restart_config:
      condition: "{{ restart_condition }}"

  no_log: "{{ not docker_service_debug }}"
  tags:
    - traefik
    - whoami

# TODO: Fix this to work with swarm mode
# - name: Deploy Docker Socket Proxy
#   community.docker.docker_swarm_service:
#   dockersocket:
#     image: tecnativa/docker-socket-proxy
#     volumes:
#       - /var/run/docker.sock:/var/run/docker.sock
#     environment:
#       CONTAINERS: 1
#       NETWORKS: 1
#       SERVICES: 1
#       SWARM: 1
#       TASKS: 1
#     deploy:
#       mode: global
#       placement:
#         constraints:
#           - "node.role==manager"
#     networks:
#       - traefik-socket


# - name: install visualizer
#   docker_swarm_service:
#     name: visualizer
#     # image: dockersamples/visualizer # X68
#     image: alexellis2/visualizer-arm:latest #ARM
#     state: absent
#     force_update: true
#     networks:
#       - 'traefik_backend'
#     mounts:
#       - source: '/var/run/docker.sock'
#         target: '/var/run/docker.sock'
#         type: 'bind'
#         readonly: true
#     restart_config:
#       condition: any
#       delay: 10s
#       # max_attempts: 5
#     labels:
#       traefik.enable: "true"
#       traefik.swarmmode: "true"
#       traefik.docker.network: "traefik_backend"
#       traefik.http.routers.visu-public-http.rule: "Host(`visualizer.{{ traefik_domain_rk1 }}`)"
#       traefik.http.routers.visu-public-http.entrypoints: "http"
#       traefik.http.services.visu-public.loadbalancer.server.port: "8080"
#     placement:
#       constraints: "node.role==manager"
